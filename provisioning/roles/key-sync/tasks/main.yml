---
- name: Create script to pull keys
  become: true
  ansible.builtin.copy:
    src: pull-keys.sh
    dest: /usr/local/bin/pull-keys.sh
    mode: "755"

- name: Create systemd service
  become: true
  ansible.builtin.template:
    src: pull-keys@.service
    dest: /etc/systemd/system/pull-keys@.service
    mode: "644"
  register: systemd_service

- name: Create systemd timer
  become: true
  ansible.builtin.template:
    src: pull-keys@.timer
    dest: /etc/systemd/system/pull-keys@.timer
    mode: "644"
  register: systemd_timer

- name: Reload systemd
  become: true
  ansible.builtin.systemd:
    daemon_reload: true
  when: systemd_service.changed or systemd_timer.changed

- name: Enable and start systemd timer
  become: true
  ansible.builtin.systemd:
    name: pull-keys@{{ ansible_user_id }}.timer
    enabled: true
    state: started
